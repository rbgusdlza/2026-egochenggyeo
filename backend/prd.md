# PRD — 이거챙겨 동작 스펙 (Change + Risk Hybrid Version)

이 문서는 앱이 사용자 입장에서 어떻게 동작해야 하는지를 정의한다.

추천 엔진은 두 가지 전략으로 동작한다:

- 외투 추천 → 전날 대비 기온 변화 기반
- 우산 추천 → 오늘 강수 위험 절대값 기반

---

## 1. 사용자 모델

### 1.1 디바이스 사용자

- 앱 최초 실행 시 `device_id(UUID)`를 생성한다.
- 모든 서버 통신은 `device_id` 기준으로 수행한다.
- `device_id`는 서버에서 유일하게 관리한다.

---

## 2. 추천의 기본 원칙

### 2.1 외투 추천 전략

- 판단 기준: 전날 동일 시각 대비 기온 변화
- 목적: 급격한 추위 변화에 대한 대응 행동 제안

### 2.2 우산 추천 전략

- 판단 기준: 오늘 출발 시각의 강수 확률 및 강수량
- 목적: 강수 리스크에 대한 사전 대비 행동 제안

---

## 3. 추천 생성 시점

### 3.1 출발 10분 전

- 사용자가 설정한 출발 시간 기준 10분 전에 추천을 생성한다.
- 사용자당 복수 일정이 존재할 수 있다.

### 3.2 스케줄러 동작

- 서버는 1분 주기로 실행된다.
- 현재 시점이 출발 10분 전인 일정들을 조회한다.
- 해당 일정에 대해 추천을 생성한다.

---

## 4. 추천 생성 파이프라인

1. 출발 10분 전 대상 조회
2. 오늘 출발 시각 기준 날씨 조회
3. 전날 동일 시각 날씨 조회 (외투 계산용)
4. 점수 계산
5. 임계치 비교
6. 추천 메시지 생성
7. 푸시 발송
8. 추천 기록 저장

---

## 5. 점수 계산 구조

점수 계산은 고정된 규칙 기반 누적 구조를 따른다.

---

### 5.1 외투 점수 계산 (변화 기반)

중간 계산: temp_diff = today_temp - yesterday_temp

입력:

- today_temp
- yesterday_temp
- wind_speed

규칙 예시:

- temp_diff <= -5  → coat_score += 30
- temp_diff <= -8  → coat_score += 20
- wind_speed >= 8  → coat_score += 10

---

### 5.2 우산 점수 계산 (절대 위험 기반)

입력:

- today_rain_probability
- expected_rainfall_mm

규칙 예시:

- rain_probability >= 40 → umbrella_score += 30
- rain_probability >= 60 → umbrella_score += 50
- expected_rainfall_mm >= 5 → umbrella_score += 30

---

### 5.3 추천 판정

- coat_score >= 50      → "외투 이거챙겨"
- umbrella_score >= 50  → "우산 이거챙겨"

임계치는 고정값으로 정의한다.

---

## 6. 피드백 수집

사용자는 추천에 대해 다음 중 하나를 선택할 수 있다:

- 도움됨
- 별로였음

저장 항목:

- device_id
- recommendation_type
- accepted (boolean)
- weather_snapshot
- timestamp

피드백은 통계 및 분석 목적 데이터로 저장한다.

---

## 7. AI 사용 범위

AI는 다음을 담당한다:

- 추천 문구 자연어 생성
- 추천 이유 설명 생성

점수 계산 및 추천 판정은 도메인 로직에서 수행한다.

---

## 8. 발송 및 일관성

- 하나의 출발 이벤트에 대해 1회 발송한다.
- 추천 생성 및 발송 기록을 저장한다.
- 외부 연동 실패 시 오류를 기록한다.
- 모든 추천은 추적 가능해야 한다.

---

## 9. 구현 원칙

- 동일한 날씨 입력에 대해 동일한 추천 결과가 생성된다.
- 추천 엔진은 순수 함수 형태로 설계한다.
- 상태 의존 없이 계산 가능하도록 구성한다.
- 테스트에서 입력 → 출력이 결정적으로 검증 가능해야 한다.

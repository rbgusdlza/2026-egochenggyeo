# REQUIREMENTS — 이거챙겨 동작 스펙(Behavior Spec)

이 문서는 “해야 할 일 목록”이 아니라,
앱이 사용자 입장에서 어떻게 동작해야 하는지(정확한 기대 동작)를 정의한다.
구현은 이 문서의 시나리오와 불변 조건을 깨지 않는 방향으로 진행한다.

---

## 1) 사용자 모델과 식별

### 1.1 로그인 없음
- 사용자는 계정이 아니라 “디바이스 사용자”다.
- 앱은 최초 실행 시 device_id(UUID)를 생성한다.
- 이후 서버와의 모든 상호작용은 device_id를 기준으로 한다.

### 1.2 서버 등록(최초 1회)
- 앱이 device_id를 서버에 등록한다.
- 서버는 device_id를 유일하게 관리한다(중복 등록 시에도 같은 사용자로 취급).

---

## 2) 출발 시간 기반 추천의 핵심 개념

### 2.1 추천의 기준은 “현재 날씨” 단독이 아니다
- 추천은 “오늘(출발 시각)의 날씨”를 보고 결정하지 않는다.
- 같은 시각의 “전날 날씨”와 비교한 변화량을 핵심 신호로 사용한다.

### 2.2 추천의 목적은 행동 제안이다
- 사용자에게 보여줄 값은 온도/풍속 같은 수치가 아니라,
  “외투 챙기기 / 우산 챙기기” 같은 행동 추천이다.

---

## 3) 추천 생성의 시간 조건

### 3.1 출발 10분 전 알림
- 사용자가 설정한 출발 시간 기준으로 “출발 10분 전”에 추천 알림을 보낸다.
- 출발 시간은 사용자별로 하나 이상 존재할 수 있다(예: 평일/주말, 또는 복수 일정).

### 3.2 스케줄러 주기
- 서버는 일정 주기로 “지금 시점에 출발 10분 전인 사용자/일정”을 찾아 추천을 생성한다.
- 주기는 구현 선택 사항이지만, MVP에서는 짧은 주기(예: 1분)를 가정한다.

---

## 4) 추천 파이프라인(정확한 단계)

추천은 다음 단계로 생성된다.

1) “출발 10분 전” 대상 사용자/스케줄을 찾는다.
2) 오늘(현재 시점)의 날씨를 조회한다.
3) 전날 동일 시각의 날씨를 조회한다.
4) 오늘 vs 전날 차이를 계산한다(변화량).
5) 규칙 기반 점수 계산으로 행동 추천 점수를 만든다.
6) 사용자 개인화 파라미터(민감도/임계치 등)를 반영한다.
7) 최종 추천 메시지를 만든다.
8) 푸시로 발송한다.
9) 추천 생성/발송 사실을 기록한다(추적 가능해야 한다).

---

## 5) 규칙 기반 점수 계산의 형태(예시)

이 문서의 수치는 “예시”이며, 형태가 중요하다.
추천은 항상 “룰 기반 점수 누적 → 개인화 계수 반영 → 임계치 비교” 구조를 따른다.

### 5.1 외투(추위) 점수 예시

- 입력: today_temp, yesterday_temp, wind_speed, cold_sensitivity
- 중간값: temp_diff = today_temp - yesterday_temp

예시 규칙:
- temp_diff <= -5  → coat_score += 30
- today_temp <= 5  → coat_score += 20
- wind_speed >= 8  → coat_score += 10

개인화 반영:
- coat_score = coat_score * cold_sensitivity

### 5.2 우산(비) 점수 예시

예시 규칙:
- rain_probability >= 60 → umbrella_score += 40
- expected_rainfall >= 5 → umbrella_score += 30

개인화 반영:
- umbrella_score = umbrella_score * rain_sensitivity

### 5.3 추천 판정(임계치)

- coat_score >= threshold → “외투 이거챙겨”
- umbrella_score >= threshold → “우산 이거챙겨”

threshold는 고정값이 아니라, 피드백을 통해 조정 가능한 값이어야 한다.

---

## 6) 피드백 수집과 개인화 보정

### 6.1 사용자가 제공하는 피드백
- 사용자는 알림을 받은 뒤 “도움이 됐어요 / 별로였어요”를 선택할 수 있다.
- 피드백은 추천 타입별로 기록된다(외투/우산 등).

### 6.2 저장해야 하는 피드백 정보(예시)
- device_id
- recommendation_type
- accepted(boolean)
- weather_snapshot(추천 생성 시점의 입력 요약)
- timestamp

### 6.3 민감도 보정 로직(형태 고정)
- accepted=true  → sensitivity += 0.05
- accepted=false → sensitivity -= 0.03
- sensitivity는 0.0 ~ 1.0 범위를 벗어나지 않는다(clamp)

이 보정 로직은 domain 내부에서만 수행한다.

---

## 7) AI 사용의 정확한 경계

AI는 “결정”이 아니라 “표현”만 담당한다.

허용:
- 추천 문구 자연어 생성
- 추천 이유 설명 생성(“왜 외투가 필요한지” 같은 설명)

금지:
- 점수 계산
- 날씨 판단
- 민감도 계산
- 스케줄링/발송 제어

즉, AI가 없어도 추천 엔진은 동일한 결과를 낼 수 있어야 한다.

---

## 8) 중복 발송/일관성(사용자 경험 불변 조건)

- 같은 출발 이벤트에 대해 알림이 여러 번 발송되면 안 된다.
- 추천 생성/발송은 추적 가능해야 한다(문제 발생 시 역추적 가능).
- 외부 연동 실패 시에도 원인 파악이 가능해야 한다(침묵 실패 금지).

---

## 9) API는 “표면”일 뿐, 동작이 우선

API는 구현 디테일이며, 중요한 것은 위 시나리오가 유지되는 것이다.
(구체 엔드포인트와 DTO는 api 레이어에서 정의한다.)
